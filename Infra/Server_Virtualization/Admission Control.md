## 1. Admission Control 개요

**Admission Control**(승인 제어)은 vSphere의 **High Availability (HA)** 기능에서 중요한 개념으로, 장애 발생 시 가상 머신(VM)을 재시작할 수 있는 자원을 보장하는 메커니즘입니다. 승인 제어는 종종 이해 부족으로 인해 비활성화되지만, 가용성을 보장하려면 반드시 활성화해야 합니다. HA는 VM이 특정 장애 상황에서 다른 호스트로 이동하여 중단 없이 계속 실행될 수 있도록 하는데, 이를 위해 자원을 미리 예약하고 유지해야 하며, 이 작업을 **승인 제어**가 담당합니다.

vSphere의 **vCenter Server**는 승인 제어를 사용하여 클러스터 내에서 장애 복구 보호가 충분히 보장되도록 자원을 확보하고, 가상 머신의 자원 예약을 준수하도록 관리합니다. 즉, 승인 제어는 가상 머신의 재시작 시 필요한 자원을 미리 확보하여 장애 발생 시에도 재시작이 가능하도록 보장합니다.

## 2. 승인 제어의 기본 동작

- **자원 예약**: 승인 제어는 클러스터 내에서 가상 머신의 장애 복구를 위해 필요한 자원을 미리 예약합니다. 장애가 발생할 경우, 이 예약된 자원을 활용해 가상 머신을 다른 호스트에서 재시작할 수 있습니다.
- **vCenter와 HA의 차이**: 승인 제어는 vCenter Server에서 관리되며, HA에 의해 발생하는 재시작을 제한하지는 않습니다. HA의 재시작은 호스트 수준에서 수행되며, vCenter Server가 직접 관여하지 않기 때문입니다.
- **리소스 관리**: 클러스터 내에서 호스트가 유지 관리 모드로 들어가거나 연결이 끊어지면 해당 호스트는 자원 계산에서 제외됩니다. 하지만, 장애가 발생한 호스트가 클러스터에서 제거되지 않으면 여전히 자원 계산에 포함됩니다.

## 3. 승인 제어 정책(Admission Control Policies)

승인 제어 정책은 클러스터에서 장애가 발생했을 때 가상 머신을 재시작하기 위한 자원이 충분한지 확인하는 방식에 대한 규칙을 정의합니다. vSphere 6.5부터 승인 제어 정책 UI는 크게 변화했고, 새로운 형식의 정책이 도입되었습니다. 다음은 주요 승인 제어 정책에 대한 설명입니다.

### 1. **클러스터 자원 비율 알고리즘 (Cluster Resource Percentage Algorithm)**

이 알고리즘은 **클러스터 내의 총 자원 중 일정 비율**을 장애 복구에 사용할 수 있도록 예약하는 방식입니다. 사용자가 장애 발생 시 허용할 수 있는 호스트 장애 수를 설정하면, 이를 기준으로 자원의 일정 비율을 자동으로 계산하여 예약합니다. 클러스터에 있는 자원을 기준으로 가상 머신이 실패 시에도 재시작할 수 있는 자원이 충분히 확보되는지 평가하는 방식입니다.

ex)

- **CPU 자원**: 클러스터의 총 CPU 자원은 24GHz
- **메모리 자원**: 클러스터의 총 메모리 자원은 96GB

이 값은 클러스터에 있는 모든 호스트의 가용 자원을 합한 값으로 여기서는 CPU와 메모리가 각각 24GHz와 96GB로 설정되어 있음

위의 계산에 따르면 CPU자원의 약 69%가 사용 가능한 상태라는 것

메모리 자원의 약 85%가 사용 가능한 상태

### 동작 방식

1. **자원 계산**: 클러스터 내 모든 호스트의 가용 CPU 및 메모리 자원을 합산한 후, 가상 머신의 현재 예약된 자원(예: CPU 예약, 메모리 예약)을 기반으로 필요한 장애 복구 자원을 계산합니다.
2. **자동 비율 계산**: 사용자가 설정한 **호스트 장애 수**에 따라, 클러스터가 자동으로 장애 복구에 필요한 자원 비율을 계산합니다. 예를 들어, 클러스터에서 두 개의 호스트 장애를 허용하도록 설정하면, 클러스터는 그에 상응하는 자원을 예약합니다.
3. **동적 조정**: 클러스터에 새로운 호스트가 추가되거나 기존 호스트가 제거되면, 이 알고리즘은 자동으로 자원을 재계산하고 자원 비율을 동적으로 조정합니다.

### 장점

- 사용자가 수동으로 자원을 계산할 필요 없이, 클러스터 내 자원이 동적으로 자동 계산되므로 **유연성**이 높습니다.
- 클러스터에 호스트를 추가하거나 제거할 때 자동으로 비율이 조정됩니다.

### 단점

- 클러스터 내 호스트 간 **자원 불균형**이 있을 경우(예: CPU와 메모리 자원의 차이), 특정 자원에서 부족이 발생할 수 있습니다. 특히, 메모리 자원이 먼저 소진될 수 있는 경우가 많습니다.

### 2. **슬롯 크기 알고리즘 (Slot Size Algorithm)**

### 원리

이 알고리즘은 클러스터 내에서 각 가상 머신이 요구하는 **최악의 경우**를 기준으로 슬롯을 정의하고, 이를 기반으로 자원을 할당하는 방식입니다. 각 가상 머신의 **최대 CPU 및 메모리 예약 값**을 기준으로 하나의 슬롯을 정의하고, 각 호스트에 할당할 수 있는 슬롯 수를 계산하여 장애 발생 시 재시작할 수 있는 가상 머신의 수를 보장합니다.

### 동작 방식

1. **슬롯 크기 계산**: 슬롯은 클러스터에서 전원이 켜진 가상 머신 중 가장 높은 CPU 및 메모리 예약값을 기준으로 결정됩니다. 슬롯의 정의는 다음과 같습니다:
    - **CPU 슬롯 크기**: 클러스터 내 가장 높은 CPU 예약을 가진 가상 머신의 CPU 예약 크기.
    - **메모리 슬롯 크기**: 클러스터 내 가장 높은 메모리 예약을 가진 가상 머신의 메모리 예약 크기(추가적인 메모리 오버헤드 포함).
2. **슬롯 할당**: 호스트의 총 CPU 및 메모리 자원을 각각의 슬롯 크기로 나누어 할당할 수 있는 슬롯 수를 결정합니다. 이때, **가장 제한적인 자원**(CPU 또는 메모리) 기준으로 할당 가능한 슬롯 수가 결정됩니다.
3. **슬롯 수 유지**: 호스트가 장애 발생 시, 그 호스트의 슬롯은 사용할 수 없기 때문에, 클러스터에서 허용하는 호스트 장애 수에 따라 여유 슬롯을 미리 확보합니다.
4. **슬롯 소비**: 각 가상 머신이 슬롯을 사용하면, 가상 머신의 요구 사항에 따라 여러 슬롯을 소비할 수 있습니다. 특히 메모리나 CPU 예약이 큰 가상 머신은 다수의 슬롯을 사용할 수 있습니다.

### 장점

- 장애 복구 시 **자원 보장이 매우 높습니다**. 각 가상 머신의 자원 요구 사항에 맞춰 슬롯을 할당하므로, 장애가 발생해도 가상 머신을 재시작할 자원이 항상 준비되어 있습니다.
- **자동 계산**: 호스트가 추가되거나 제거될 때 자동으로 슬롯 크기를 다시 계산하여 관리합니다.

### 단점

- **보수적**인 알고리즘입니다. 클러스터 내 가상 머신 중 하나라도 높은 자원 예약을 가지고 있다면, 그 자원이 슬롯 크기를 결정하며, 자원 낭비가 발생할 수 있습니다.
- **불균형한 클러스터**에서는 자원 낭비가 심할 수 있으며, 호스트 간 자원이 균일하지 않다면 슬롯 크기 결정 시 문제가 발생할 수 있습니다.

### 3. **전용 장애 복구 호스트 알고리즘 (Dedicated Failover Hosts Algorithm)**

### 원리

이 알고리즘은 특정 호스트를 **전용 장애 복구 호스트**로 지정하는 방식입니다. 이 호스트는 평상시에는 가상 머신을 실행하지 않고, 장애가 발생했을 때만 가상 머신을 재시작하는 데 사용됩니다. 즉, 전용 장애 복구 호스트는 "핫 스탠바이" 상태로 대기하다가 장애가 발생하면 가상 머신을 복구하는 데 사용됩니다.

### 동작 방식

1. **호스트 지정**: 클러스터 내에서 하나 이상의 호스트를 전용 장애 복구 호스트로 지정합니다. 지정된 호스트는 평상시에는 DRS(Distributed Resource Scheduler)에 의해 자원이 배치되지 않으며, 가상 머신을 실행하지 않습니다.
2. **장애 발생 시 동작**: 장애가 발생하면, 해당 장애로 인해 중단된 가상 머신을 전용 장애 복구 호스트에서 재시작합니다. 지정된 호스트가 여러 개일 경우, HA는 여러 전용 장애 복구 호스트를 사용하여 가상 머신을 분산 배치할 수 있습니다.
3. **재시작 실패 시 처리**: 만약 전용 장애 복구 호스트가 여러 개의 장애를 감당하지 못하거나, 전용 호스트 자체가 실패한 경우, 다른 클러스터 호스트에서 가상 머신을 재시작하는 방법을 시도합니다.

### 장점

- **장애 복구 보장**: 전용 호스트가 장애 발생 시 가상 머신 재시작에만 사용되므로, 자원 부족 문제 없이 안정적으로 복구할 수 있습니다.
- **명확한 자원 관리**: 전용 호스트는 장애 복구에만 사용되므로, 자원이 분명하게 관리됩니다.

### 단점

- **자원 낭비**: 평상시에는 전용 장애 복구 호스트가 사용되지 않기 때문에, 자원이 비효율적으로 사용될 수 있습니다.
- **작은 클러스터에서 비효율적**: 클러스터가 작은 경우(예: 2호스트 클러스터), 전용 호스트로 자원을 낭비하게 되어 비효율적입니다.

## 4. 승인 제어의 성능 저하 허용 (Performance Degradation Toleration)

승인 제어는 장애가 발생했을 때, 가상 머신이 재시작될 수 있도록 자원을 예약하지만, 재시작된 후 성능이 저하될 가능성이 있습니다. vSphere 6.5에서는 장애 발생 후 허용할 수 있는 성능 저하 정도를 설정할 수 있는 기능이 추가되었습니다. 기본값은 성능 저하를 100% 허용하는 것이지만, 실제 운영 환경에서는 성능 저하를 25% 또는 50%로 설정하는 것이 일반적입니다.

**성능 저하 허용 설정의 예**

- **사용 가능한 메모리**: 75GB
- **호스트 장애 허용 수**: 1
- **사용 중인 메모리**: 60GB
- **성능 저하 허용 비율**: 0%

위와 같은 설정일 경우, 장애 발생 후 사용 가능한 메모리가 50GB이므로, 60GB의 메모리가 필요한 상황에서는 성능 저하가 발생하게 됩니다. 이 경우 관리자는 추가 호스트를 구매하여 클러스터에 추가하거나, 성능 저하를 허용하는 결정을 내려야 합니다.

## 5. 승인 제어 정책 선택 시 고려 사항

승인 제어 정책을 선택할 때는 환경에 따라 다양한 요소를 고려해야 합니다.

### 1) **클러스터 자원 비율 정책**

- 이 정책은 VM의 실제 자원 예약을 기반으로 장애 복구를 위한 자원을 계산하기 때문에, 유연성이 높습니다.
- 대부분의 환경에서 가장 널리 사용되는 정책이며, 클러스터에 새로운 호스트가 추가될 때 자동으로 자원을 재조정합니다.
- 그러나 불균형한 클러스터에서는 문제가 될 수 있습니다.

### 2) **슬롯 크기 정책**

- 슬롯 크기 정책은 특정 슬롯 크기를 정의하여 장애 복구를 보장합니다.
- 그러나, 자원 예약이 많은 VM이 있을 경우 보수적인 설정으로 인해 자원 낭비가 발생할 수 있습니다.

### 3) **전용 장애 복구 호스트 정책**

- 전용 장애 복구 호스트 정책은 호스트를 "핫 스탠바이" 상태로 유지하여 장애 시 재시작을 보장합니다.
- 하지만, 평상시에는 자원이 낭비될 수 있으며, 작은 클러스터에서는 효과적이지 않을 수 있습니다.

## 6. 권장 사항

일반적으로, **클러스터 자원 비율 정책**을 사용하는 것이 가장 유연하고 적합한 방법입니다. 이 정책은 자원을 보다 효율적으로 관리할 수 있고, 새로운 호스트가 추가되었을 때 자동으로 자원을 재조정하므로 편리합니다.

- **슬롯 크기 정책**은 특정 환경에서 필요할 수 있지만, 자원 낭비를 초래할 수 있는 복잡한 정책이므로 신중하게 사용해야 합니다.
- **전용 장애 복구 호스트 정책**은 가용성을 보장하지만, 자원이 낭비될 수 있는 단점이 있습니다.

**적절한 비율 선택**

비율 기반 승인 제어 정책을 사용할 경우, 적절한 비율을 선택하는 것이 중요합니다. 이상적인 비율은 클러스터의 크기와 복원력 모델(N+1, N+2 등)에 따라 달라집니다.

vSphere 6.5 이전에는 사용자가 직접 CPU와 메모리의 비율을 수동으로 설정해야 했습니다. 일반적으로, 하나의 호스트 또는 여러 호스트를 기준으로 비율을 설정하는 것이 전략적으로 권장되었습니다. vSphere 6.5 이후로는 사용자가 수동으로 비율을 설정하거나, **"Host failures cluster tolerates"** 기능을 활용하여 자동으로 계산할 수 있습니다.

**수동 비율 설정 시 주의사항**

만약 수동으로 비율을 설정해야 하는 경우, **비율을 하나의 호스트 값 이상으로 설정**해야 합니다. 예를 들어, 4개의 호스트로 구성된 클러스터에서는 비율을 25% 이상으로 설정하는 것이 권장됩니다. 비율을 너무 낮게 설정할 경우, 장애 발생 시 모든 가상 머신을 복구할 수 있는 자원이 부족할 수 있습니다.

**예시: 8개의 ESXi 호스트로 구성된 클러스터**

다음은 8개의 ESXi 호스트로 구성된 클러스터에서 메모리와 CPU 자원을 설정하는 예시입니다. 각 호스트는 **70GB의 가용 메모리**를 가지고 있습니다(2GB는 가상화 오버헤드로 이미 제외된 상태입니다). 이 예시는 메모리 자원을 기준으로 설명하지만, 같은 개념이 CPU 자원에도 적용됩니다.

- 클러스터의 총 메모리 자원: 70GB * 8 = 560GB
- 20%의 자원을 장애 복구용으로 예약한다고 가정했을 때:총 112GB의 메모리를 장애 복구 용도로 예약하게 됩니다.

    ```scss
    scss
    코드 복사
    (70GB + 70GB + 70GB + 70GB + 70GB + 70GB + 70GB + 70GB) * (1 – 20%) = 448GB
    ```


이때, 설정된 비율이 하나의 호스트가 제공하는 자원보다 크면, 불필요한 자원이 예약될 수 있습니다. HA의 주요 목표는 물리적 서버 장애 후 가상 머신의 자동 복구를 제공하는 것이기 때문에, 일반적으로 하나의 호스트(또는 여러 호스트)의 자원만큼을 예약하는 것이 좋습니다. 이 예시에서, 각 호스트는 클러스터에 **12.5%의 자원**을 기여하므로, 이를 고려하여 비율을 13%로 설정하는 것이 적절합니다.

**공격적인 설정(비율을 낮게 설정하는 경우)**

일부 환경에서는 **비율을 하나의 호스트 기여 비율보다 낮게** 설정하는 경우가 있습니다. 이렇게 하면 장애 복구를 위한 자원 예약이 줄어들어 더 많은 가상 머신을 실행할 수 있는 이점이 있지만, 장애 발생 시 모든 가상 머신을 재시작할 수 있는 보장이 줄어듭니다.

이러한 방식은 대부분의 환경이 완전히 자원을 소진하지 않는다는 가정 하에 동작할 수 있지만, 설정된 비율이 너무 낮으면 장애 발생 시 오류 메시지가 발생할 수 있으며, 모든 가상 머신이 복구되지 않을 위험이 있습니다. 이 경우, **고가용성(HA)을 설정한 이유 자체를 무색하게 만들 수 있습니다**.

**클러스터 확장 시 고려사항**

클러스터를 확장할 때, 이전에 설정한 비율이 확장된 클러스터에서 적절한지 검토해야 합니다. 예를 들어, 8개의 호스트로 구성된 클러스터에 4개의 호스트를 추가한다고 가정해보겠습니다. 이때 이전에 설정한 비율이 13%였다면, 이는 하나의 호스트가 아니라 **1.5개의 호스트**에 해당하는 자원을 예약하게 되어 자원 낭비가 발생할 수 있습니다.

따라서, 클러스터가 확장되면 **새로운 호스트의 자원 기여도를 고려해 비율을 재조정**하는 것이 중요합니다.